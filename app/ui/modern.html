<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenAI Studio (Hackathon PoC)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'teal': {
                            500: '#14b8a6',
                            600: '#0d9488',
                        },
                        'slate': {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .chat-message {
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .tool-chip {
            transition: all 0.2s ease;
        }
        .tool-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .redacted-text {
            background: linear-gradient(90deg, #94a3b8 25%, transparent 25%);
            background-size: 8px 1px;
            background-repeat: repeat-x;
            background-position: 0 50%;
            color: transparent;
        }
        .redacted-text:hover::after {
            content: " (Redacted)";
            color: #64748b;
            font-size: 0.75rem;
            background: #1e293b;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }
        
        /* Enhanced markdown styles */
        .markdown-content {
            line-height: 1.6;
        }
        
        .markdown-content pre {
            margin: 1rem 0;
            position: relative;
        }
        
        .markdown-content code {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
        }
        
        .markdown-content pre code {
            color: #e6ffed !important;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
        }
        
        /* Override highlight.js theme for better visibility */
        .hljs {
            background: #1e293b !important;
            color: #e2e8f0 !important;
        }
        
        .hljs-keyword { color: #f59e0b !important; }
        .hljs-string { color: #10b981 !important; }
        .hljs-comment { color: #6b7280 !important; }
        .hljs-function { color: #3b82f6 !important; }
        .hljs-variable { color: #8b5cf6 !important; }
        .hljs-number { color: #f472b6 !important; }
        .hljs-built_in { color: #06b6d4 !important; }
    </style>
</head>
<body class="h-full bg-slate-50">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const ReactMarkdown = window.ReactMarkdown;
        
        // Custom components for react-markdown
        const markdownComponents = {
            code: ({ node, inline, className, children, ...props }) => {
                const match = /language-(\w+)/.exec(className || '');
                const language = match ? match[1] : '';
                
                return !inline ? (
                    <div className="my-4">
                        {language && (
                            <div className="bg-slate-100 px-3 py-1 text-xs font-mono text-slate-600 border-t border-l border-r border-slate-300 rounded-t">
                                {language}
                            </div>
                        )}
                        <pre className={`bg-slate-900 text-green-400 p-4 rounded${language ? '-b' : ''} overflow-x-auto`}>
                            <code className={className} {...props}>
                                {children}
                            </code>
                        </pre>
                    </div>
                ) : (
                    <code className="bg-slate-100 text-slate-800 px-1.5 py-0.5 rounded text-sm font-mono" {...props}>
                        {children}
                    </code>
                );
            },
            h1: ({ children }) => <h1 className="text-2xl font-bold text-slate-800 mt-8 mb-4">{children}</h1>,
            h2: ({ children }) => <h2 className="text-xl font-bold text-slate-800 mt-6 mb-3">{children}</h2>,
            h3: ({ children }) => <h3 className="text-lg font-semibold text-slate-800 mt-4 mb-2">{children}</h3>,
            p: ({ children }) => <p className="mb-3 leading-relaxed">{children}</p>,
            ul: ({ children }) => <ul className="list-disc list-inside mb-3 space-y-1">{children}</ul>,
            ol: ({ children }) => <ol className="list-decimal list-inside mb-3 space-y-1">{children}</ol>,
            li: ({ children }) => <li className="ml-2">{children}</li>,
            strong: ({ children }) => <strong className="font-semibold text-slate-800">{children}</strong>,
            em: ({ children }) => <em className="italic">{children}</em>,
            blockquote: ({ children }) => (
                <blockquote className="border-l-4 border-slate-300 pl-4 italic text-slate-600 mb-3">
                    {children}
                </blockquote>
            )
        };

        // Agent configurations
        const AGENTS = {
            'smart': {
                name: 'Smart Chat',
                icon: 'fa-brain',
                color: 'text-teal-600',
                example: 'Find a standing desk under ₹50k with 12-mo 0% APR',
                tooltip: 'AI router - finds the best agent for your query'
            },
            'offerpilot': {
                name: 'OfferPilot',
                icon: 'fa-tags',
                color: 'text-blue-600',
                example: 'Show me laptops under ₹80k with financing options',
                tooltip: 'Product search with financing pre-qualification'
            },
            'trustshield': {
                name: 'TrustShield',
                icon: 'fa-shield-halved',
                color: 'text-red-600',
                example: 'I got an email asking for gift cards as refund',
                tooltip: 'Fraud detection and PII protection system'
            },
            'dispute': {
                name: 'Dispute',
                icon: 'fa-gavel',
                color: 'text-amber-600',
                example: 'Charged twice for ₹12,499 at Amazon on Dec 15th',
                tooltip: 'Transaction dispute resolution assistant'
            },
            'collections': {
                name: 'Collections',
                icon: 'fa-handshake',
                color: 'text-green-600',
                example: 'I have ₹25k balance at 24% APR, need payment options',
                tooltip: 'Hardship and payment plan assistance'
            },
            'contracts': {
                name: 'Contracts',
                icon: 'fa-file-contract',
                color: 'text-purple-600',
                example: 'Review my merchant agreement for key obligations',
                tooltip: 'Contract analysis and obligation tracking'
            },
            'devcopilot': {
                name: 'DevCopilot',
                icon: 'fa-code',
                color: 'text-indigo-600',
                example: 'Generate Python code for payments API integration',
                tooltip: 'Developer tools and API integration help'
            },
            'carecredit': {
                name: 'CareCredit',
                icon: 'fa-heart-pulse',
                color: 'text-pink-600',
                example: 'Dental procedure costs ₹45k, what are my options?',
                tooltip: 'Healthcare financing and payment plans'
            },
            'narrator': {
                name: 'Narrator',
                icon: 'fa-chart-line',
                color: 'text-orange-600',
                example: 'Why did spend drop after 2025-07-31?',
                tooltip: 'Portfolio analytics and business insights'
            },
            'imagegen': {
                name: 'ImageGen',
                icon: 'fa-image',
                color: 'text-violet-600',
                example: 'Create a futuristic city with flying cars and neon lights',
                tooltip: 'AI-powered image generation from text descriptions'
            }
        };

        // Main App Component
        function App() {
            const [selectedAgent, setSelectedAgent] = useState('smart');
            const [allowTavily, setAllowTavily] = useState(false);
            const [allowLlmKnowledge, setAllowLlmKnowledge] = useState(true);
            const [allowWebSearch, setAllowWebSearch] = useState(false);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [rightPanel, setRightPanel] = useState('citations');
            const [citations, setCitations] = useState([]);
            const [toolTrace, setToolTrace] = useState([]);
            const [uploadedPdfs, setUploadedPdfs] = useState([]);
            const [selectedPdfChunk, setSelectedPdfChunk] = useState(null);
            const messagesEndRef = useRef(null);

            // Auto-scroll to bottom when messages change
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            // Highlight code blocks after messages update
            useEffect(() => {
                if (window.hljs) {
                    setTimeout(() => window.hljs.highlightAll(), 100);
                }
            }, [messages]);

            const sendMessage = async () => {
                if (!inputText.trim()) return;

                const userMessage = {
                    id: Date.now(),
                    type: 'user',
                    content: inputText,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                setIsLoading(true);

                try {
                    const endpoint = selectedAgent === 'smart' ? '/chat' : `/agent/${selectedAgent}`;
                    const payload = selectedAgent === 'smart' 
                        ? { 
                            message: inputText, 
                            allow_tavily: allowTavily,
                            allow_llm_knowledge: allowLlmKnowledge,
                            allow_web_search: allowWebSearch
                        }
                        : selectedAgent === 'imagegen'
                        ? { prompt: inputText, include_text: true, style_hints: [] }
                        : { query: inputText };

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    
                    const assistantMessage = {
                        id: Date.now() + 1,
                        type: 'assistant',
                        content: data.response || data,
                        agent: data.agent || selectedAgent,
                        confidence: data.confidence || 1.0,
                        sources: data.sources || [],
                        used_tavily: data.used_tavily || false,
                        timestamp: new Date(),
                        latency: Math.random() * 2000 + 500, // Mock latency
                        image_data: data.image_data,
                        image_format: data.image_format
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                    setCitations(data.sources || []);
                    setToolTrace(prev => [...prev, {
                        tool: selectedAgent,
                        args: payload,
                        result: data,
                        timestamp: new Date()
                    }]);

                } catch (error) {
                    console.error('Error sending message:', error);
                    setMessages(prev => [...prev, {
                        id: Date.now() + 1,
                        type: 'error',
                        content: 'Sorry, there was an error processing your request.',
                        timestamp: new Date()
                    }]);
                }

                setInputText('');
                setIsLoading(false);
            };

            const useExample = (agentKey) => {
                setInputText(AGENTS[agentKey].example);
                setSelectedAgent(agentKey);
            };

            const clearChat = () => {
                setMessages([]);
                setCitations([]);
                setToolTrace([]);
            };

            const uploadPdf = async (file) => {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/upload/pdf', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Upload failed with status ${response.status}:`, errorText);
                        throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        setUploadedPdfs(prev => [...prev, result]);
                        
                        // Get first page thumbnail for display
                        let thumbnailImage = null;
                        try {
                            const pageResponse = await fetch(`/pdf/${result.pdf_id}/page/0`);
                            if (pageResponse.ok) {
                                const pageData = await pageResponse.json();
                                thumbnailImage = pageData.image_base64;
                            }
                        } catch (error) {
                            console.error('Failed to fetch PDF thumbnail:', error);
                        }
                        
                        // Add upload notification to chat with PDF data
                        const uploadMessage = {
                            id: Date.now(),
                            type: 'pdf_upload',
                            content: `📄 Uploaded and processed: ${result.filename} (${result.chunks_extracted} chunks from ${result.total_pages} pages)`,
                            timestamp: new Date(),
                            pdfData: result,
                            thumbnail: thumbnailImage
                        };
                        setMessages(prev => [...prev, uploadMessage]);
                        
                        return result;
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('PDF upload error:', error);
                    
                    const errorMessage = {
                        id: Date.now(),
                        type: 'error',
                        content: `Failed to upload PDF: ${error.message}`,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                    
                    throw error;
                }
            };

            const exportJSON = () => {
                const lastMessage = messages[messages.length - 1];
                if (lastMessage && lastMessage.type === 'assistant') {
                    const blob = new Blob([JSON.stringify(lastMessage, null, 2)], 
                        { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `genai-response-${Date.now()}.json`;
                    a.click();
                }
            };

            return (
                <div className="h-screen flex flex-col bg-slate-50">
                    {/* Header */}
                    <Header 
                        allowTavily={allowTavily}
                        setAllowTavily={setAllowTavily}
                        allowLlmKnowledge={allowLlmKnowledge}
                        setAllowLlmKnowledge={setAllowLlmKnowledge}
                        allowWebSearch={allowWebSearch}
                        setAllowWebSearch={setAllowWebSearch}
                        onClear={clearChat}
                        onExport={exportJSON}
                    />

                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* Left Rail */}
                        <LeftRail 
                            selectedAgent={selectedAgent}
                            onSelectAgent={setSelectedAgent}
                            onUseExample={useExample}
                        />

                        {/* Chat Pane */}
                        <ChatPane
                            messages={messages}
                            isLoading={isLoading}
                            inputText={inputText}
                            setInputText={setInputText}
                            selectedAgent={selectedAgent}
                            allowTavily={allowTavily}
                            setAllowTavily={setAllowTavily}
                            onSendMessage={sendMessage}
                            messagesEndRef={messagesEndRef}
                            uploadedPdfs={uploadedPdfs}
                            setUploadedPdfs={setUploadedPdfs}
                            uploadPdf={uploadPdf}
                        />

                        {/* Right Inspector */}
                        <RightInspector
                            activePanel={rightPanel}
                            setActivePanel={setRightPanel}
                            citations={citations}
                            toolTrace={toolTrace}
                            uploadedPdfs={uploadedPdfs}
                            selectedPdfChunk={selectedPdfChunk}
                            setSelectedPdfChunk={setSelectedPdfChunk}
                        />
                    </div>
                </div>
            );
        }

        // Header Component
        function Header({ allowTavily, setAllowTavily, allowLlmKnowledge, setAllowLlmKnowledge, allowWebSearch, setAllowWebSearch, onClear, onExport }) {
            return (
                <header className="bg-white border-b border-slate-200 px-6 py-3">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-xl font-semibold text-slate-800">
                                GenAI Studio <span className="text-sm font-normal text-slate-500">(Hackathon PoC)</span>
                            </h1>
                            <div className="flex items-center space-x-3">
                                <span className="px-2 py-1 text-xs bg-slate-100 text-slate-600 rounded-md">
                                    Local • No DB
                                </span>
                                <div className="space-y-2">
                                    <label className="flex items-center space-x-2 text-sm">
                                        <input
                                            type="checkbox"
                                            checked={allowTavily}
                                            onChange={(e) => setAllowTavily(e.target.checked)}
                                            className="rounded text-teal-600 focus:ring-teal-500"
                                        />
                                        <span className="text-slate-600">Allow Tavily (legacy)</span>
                                    </label>
                                    <label className="flex items-center space-x-2 text-sm">
                                        <input
                                            type="checkbox"
                                            checked={allowLlmKnowledge}
                                            onChange={(e) => setAllowLlmKnowledge(e.target.checked)}
                                            className="rounded text-blue-600 focus:ring-blue-500"
                                        />
                                        <span className="text-slate-600">LLM Knowledge Fallback</span>
                                    </label>
                                    <label className="flex items-center space-x-2 text-sm">
                                        <input
                                            type="checkbox"
                                            checked={allowWebSearch}
                                            onChange={(e) => setAllowWebSearch(e.target.checked)}
                                            className="rounded text-purple-600 focus:ring-purple-500"
                                        />
                                        <span className="text-slate-600">Web Search Fallback</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center space-x-3">
                            <span className="px-2 py-1 text-xs bg-green-100 text-green-600 rounded-md">
                                PII Redaction ON
                            </span>
                            <button
                                onClick={onClear}
                                className="px-3 py-1 text-sm text-slate-600 hover:text-slate-800"
                            >
                                Clear
                            </button>
                            <button
                                onClick={onExport}
                                className="px-3 py-1 text-sm text-slate-600 hover:text-slate-800"
                            >
                                Export JSON
                            </button>
                            <span className="px-2 py-1 text-xs bg-amber-100 text-amber-700 rounded-md">
                                Demo — not legal/credit advice
                            </span>
                        </div>
                    </div>
                </header>
            );
        }

        // Left Rail Component
        function LeftRail({ selectedAgent, onSelectAgent, onUseExample }) {
            return (
                <div className="w-64 bg-white border-r border-slate-200 flex flex-col">
                    <div className="p-4 border-b border-slate-200">
                        <h2 className="font-medium text-slate-800 mb-3">Agents</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto">
                        {Object.entries(AGENTS).map(([key, agent]) => (
                            <AgentItem
                                key={key}
                                agentKey={key}
                                agent={agent}
                                isSelected={selectedAgent === key}
                                onSelect={() => onSelectAgent(key)}
                                onUseExample={() => onUseExample(key)}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        // Agent Item Component
        function AgentItem({ agentKey, agent, isSelected, onSelect, onUseExample }) {
            return (
                <div 
                    className={`p-3 border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors ${
                        isSelected ? 'bg-teal-50 border-r-2 border-teal-500' : ''
                    }`}
                    onClick={onSelect}
                >
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                            <i className={`fas ${agent.icon} ${agent.color}`}></i>
                            <div>
                                <div className="font-medium text-sm text-slate-800">
                                    {agent.name}
                                </div>
                                <div className="text-xs text-slate-500 mt-1">
                                    {agent.tooltip}
                                </div>
                            </div>
                        </div>
                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                onUseExample();
                            }}
                            className="text-xs text-teal-600 hover:text-teal-700 p-1"
                            title="Try Example"
                        >
                            <i className="fas fa-play"></i>
                        </button>
                    </div>
                </div>
            );
        }

        // Chat Pane Component
        function ChatPane({ messages, isLoading, inputText, setInputText, selectedAgent, allowTavily, setAllowTavily, onSendMessage, messagesEndRef, uploadedPdfs, setUploadedPdfs, uploadPdf }) {
            const [isDragOver, setIsDragOver] = useState(false);
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    if (e.shiftKey || e.ctrlKey) {
                        // Allow new line on Shift+Enter or Ctrl+Enter
                        return;
                    } else {
                        // Send message on plain Enter
                        e.preventDefault();
                        if (inputText.trim()) {
                            onSendMessage();
                        }
                    }
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
            };

            const handleDrop = async (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);

                const files = Array.from(e.dataTransfer.files);
                console.log('Dropped files:', files.map(f => ({ name: f.name, type: f.type, size: f.size })));
                
                const pdfFiles = files.filter(file => 
                    file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
                );

                if (pdfFiles.length === 0) {
                    alert('Please drop PDF files only.');
                    return;
                }

                console.log('Processing PDF files:', pdfFiles.map(f => f.name));

                // Upload each PDF file
                for (const file of pdfFiles) {
                    try {
                        console.log(`Uploading PDF: ${file.name}`);
                        await uploadPdf(file);
                        console.log(`Successfully uploaded: ${file.name}`);
                    } catch (error) {
                        console.error(`Error uploading PDF ${file.name}:`, error);
                    }
                }
            };

            return (
                <div 
                    className="flex-1 flex flex-col bg-white relative"
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                >
                    {/* Chat Header */}
                    <div className="p-4 border-b border-slate-200">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <i className={`fas ${AGENTS[selectedAgent].icon} ${AGENTS[selectedAgent].color}`}></i>
                                <span className="font-medium text-slate-800">{AGENTS[selectedAgent].name}</span>
                                {selectedAgent !== 'smart' && (
                                    <span className="px-2 py-1 text-xs bg-slate-100 text-slate-600 rounded">
                                        Direct Mode
                                    </span>
                                )}
                            </div>
                            <div className="text-sm text-slate-500">
                                {messages.length} messages
                            </div>
                        </div>
                    </div>

                    {/* Messages */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.length === 0 && (
                            <div className="text-center py-12">
                                <i className={`fas ${AGENTS[selectedAgent].icon} text-4xl ${AGENTS[selectedAgent].color} mb-4`}></i>
                                <h3 className="text-lg font-medium text-slate-800 mb-2">
                                    {AGENTS[selectedAgent].name}
                                </h3>
                                <p className="text-slate-600 mb-4">
                                    {AGENTS[selectedAgent].tooltip}
                                </p>
                                <div className="text-sm text-slate-500">
                                    Try: "{AGENTS[selectedAgent].example}"
                                </div>
                            </div>
                        )}
                        
                        {messages.map((message) => (
                            <ChatMessage key={message.id} message={message} />
                        ))}
                        
                        {isLoading && (
                            <div className="flex justify-center py-4">
                                <div className="flex items-center space-x-2 text-slate-500">
                                    <div className="animate-spin h-4 w-4 border-2 border-teal-500 border-t-transparent rounded-full"></div>
                                    <span>Thinking...</span>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>

                    {/* Drag & Drop Overlay */}
                    {isDragOver && (
                        <div className="absolute inset-0 bg-teal-500 bg-opacity-10 border-2 border-dashed border-teal-500 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg shadow-lg text-center">
                                <i className="fas fa-file-pdf text-4xl text-teal-600 mb-2"></i>
                                <p className="text-lg font-medium text-slate-800 mb-1">Drop PDF files here</p>
                                <p className="text-sm text-slate-600">Upload documents to analyze and chat about</p>
                            </div>
                        </div>
                    )}

                    {/* Composer */}
                    <div className="border-t border-slate-200 p-4">
                        {/* PDF Upload Area */}
                        {uploadedPdfs.length > 0 && (
                            <div className="mb-3 p-2 bg-slate-50 rounded border border-slate-200">
                                <div className="text-xs text-slate-600 mb-2">📄 Attached PDFs:</div>
                                <div className="flex flex-wrap gap-2">
                                    {uploadedPdfs.map((pdf, index) => (
                                        <div key={index} className="flex items-center space-x-2 bg-white px-2 py-1 rounded border text-xs">
                                            <i className="fas fa-file-pdf text-red-600"></i>
                                            <span>{pdf.filename}</span>
                                            <span className="text-slate-500">({pdf.chunks_extracted} chunks)</span>
                                            <button
                                                onClick={() => setUploadedPdfs(prev => prev.filter((_, i) => i !== index))}
                                                className="text-slate-400 hover:text-red-600 ml-1"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Input Container */}
                        <div className="relative bg-white border border-slate-300 rounded-lg focus-within:border-teal-500 focus-within:ring-1 focus-within:ring-teal-500">
                            <div className="flex items-end">
                                {/* Plus Button */}
                                <div className="flex-shrink-0 p-2">
                                    <label className="cursor-pointer text-slate-500 hover:text-slate-700 transition-colors">
                                        <input
                                            type="file"
                                            accept=".pdf"
                                            className="hidden"
                                            onChange={async (e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    try {
                                                        await uploadPdf(file);
                                                    } catch (error) {
                                                        // Error already handled in uploadPdf
                                                    }
                                                    e.target.value = ''; // Reset input
                                                }
                                            }}
                                        />
                                        <div className="w-6 h-6 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-50 transition-colors">
                                            <i className="fas fa-plus text-xs"></i>
                                        </div>
                                    </label>
                                </div>

                                {/* Text Input */}
                                <div className="flex-1 min-h-[44px]">
                                    <textarea
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        onKeyPress={handleKeyPress}
                                        placeholder={selectedAgent === 'smart' 
                                            ? 'Ask about your documents, shop + finance, dispute, contracts...'
                                            : `Ask ${AGENTS[selectedAgent].name}...`
                                        }
                                        className="w-full px-2 py-2 border-0 bg-transparent resize-none focus:outline-none"
                                        rows={Math.min(inputText.split('\n').length, 4)}
                                        disabled={isLoading}
                                    />
                                </div>

                                {/* Send Button */}
                                <div className="flex-shrink-0 p-2">
                                    <button
                                        onClick={onSendMessage}
                                        disabled={isLoading || !inputText.trim()}
                                        className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${
                                            inputText.trim() && !isLoading
                                                ? 'bg-teal-600 text-white hover:bg-teal-700'
                                                : 'bg-slate-100 text-slate-400'
                                        }`}
                                    >
                                        <i className="fas fa-paper-plane text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Footer Info */}
                        <div className="flex items-center justify-between mt-2">
                            <div className="flex items-center space-x-4">
                                {selectedAgent === 'smart' && (
                                    <label className="flex items-center space-x-1 text-xs text-slate-500">
                                        <input
                                            type="checkbox"
                                            checked={allowTavily}
                                            onChange={(e) => setAllowTavily(e.target.checked)}
                                            className="rounded"
                                        />
                                        <span>Use Tavily</span>
                                    </label>
                                )}
                            </div>
                            <div className="text-xs text-slate-400">
                                {inputText.length} chars • Enter to send • Shift+Enter for new line
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Chat Message Component
        function ChatMessage({ message }) {
            if (message.type === 'user') {
                return (
                    <div className="flex justify-end">
                        <div className="bg-teal-600 text-white px-4 py-2 rounded-lg max-w-md">
                            {message.content}
                        </div>
                    </div>
                );
            }

            if (message.type === 'error') {
                return (
                    <div className="flex">
                        <div className="bg-red-100 text-red-700 px-4 py-2 rounded-lg max-w-md">
                            <i className="fas fa-exclamation-triangle mr-2"></i>
                            {message.content}
                        </div>
                    </div>
                );
            }

            if (message.type === 'pdf_upload') {
                return (
                    <div className="flex">
                        <div className="bg-blue-50 border border-blue-200 px-4 py-3 rounded-lg max-w-md">
                            <div className="flex items-start space-x-3">
                                {message.thumbnail && (
                                    <div className="flex-shrink-0">
                                        <img 
                                            src={`data:image/png;base64,${message.thumbnail}`} 
                                            alt="PDF Thumbnail"
                                            className="w-16 h-20 object-cover rounded border border-slate-200 shadow-sm"
                                        />
                                    </div>
                                )}
                                <div className="flex-1">
                                    <div className="flex items-center space-x-2 mb-1">
                                        <i className="fas fa-file-pdf text-red-600"></i>
                                        <span className="font-medium text-sm text-slate-800">
                                            {message.pdfData?.filename}
                                        </span>
                                    </div>
                                    <div className="text-xs text-slate-600 space-y-1">
                                        <div>📄 {message.pdfData?.total_pages} pages</div>
                                        <div>🧩 {message.pdfData?.chunks_extracted} chunks extracted</div>
                                        <div>⚡ Processed in {message.pdfData?.processing_time?.toFixed(2)}s</div>
                                    </div>
                                    <div className="text-xs text-slate-500 mt-2">
                                        Ready for questions about this document
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chat-message">
                    <div className="flex items-start space-x-3">
                        <div className={`w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center`}>
                            <i className={`fas ${AGENTS[message.agent]?.icon || 'fa-robot'} text-slate-600`}></i>
                        </div>
                        <div className="flex-1">
                            {/* Message Header */}
                            <div className="flex items-center space-x-2 mb-2">
                                <span className="font-medium text-sm text-slate-800">
                                    {AGENTS[message.agent]?.name || message.agent}
                                </span>
                                <span className="text-xs text-slate-500">
                                    {message.timestamp.toLocaleTimeString()}
                                </span>
                                {message.latency && (
                                    <span className="text-xs text-slate-400">
                                        {Math.round(message.latency)}ms
                                    </span>
                                )}
                                {message.confidence && (
                                    <span className={`text-xs px-1 py-0.5 rounded ${
                                        message.confidence > 0.8 ? 'bg-green-100 text-green-600' :
                                        message.confidence > 0.6 ? 'bg-yellow-100 text-yellow-600' :
                                        'bg-red-100 text-red-600'
                                    }`}>
                                        {Math.round(message.confidence * 100)}%
                                    </span>
                                )}
                                {message.used_tavily && (
                                    <span className="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">
                                        <i className="fas fa-globe mr-1"></i>
                                        Web Enhanced
                                    </span>
                                )}
                            </div>

                            {/* Message Content */}
                            <div className="prose prose-sm max-w-none text-slate-700">
                                {typeof message.content === 'string' ? (
                                    <ReactMarkdown 
                                        components={markdownComponents}
                                        className="markdown-content"
                                    >
                                        {message.content.replace(/\[REDACTED[^\]]*\]/g, '████████')}
                                    </ReactMarkdown>
                                ) : (
                                    <pre className="text-sm bg-slate-50 p-3 rounded border overflow-x-auto">
                                        {JSON.stringify(message.content, null, 2)}
                                    </pre>
                                )}
                            </div>

                            {/* Generated Image Display */}
                            {message.image_data && (
                                <div className="mt-4">
                                    <div className="border border-slate-200 rounded-lg overflow-hidden bg-slate-50">
                                        <div className="p-3 bg-slate-100 border-b border-slate-200">
                                            <div className="flex items-center justify-between text-sm">
                                                <div className="flex items-center space-x-2">
                                                    <i className="fas fa-image text-violet-600"></i>
                                                    <span className="font-medium text-slate-800">Generated Image</span>
                                                    <span className="px-2 py-1 text-xs bg-violet-100 text-violet-700 rounded">
                                                        {message.image_format || 'PNG'}
                                                    </span>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        const link = document.createElement('a');
                                                        link.download = `generated-image-${Date.now()}.${(message.image_format || 'PNG').toLowerCase()}`;
                                                        link.href = `data:image/${(message.image_format || 'png').toLowerCase()};base64,${message.image_data}`;
                                                        link.click();
                                                    }}
                                                    className="text-slate-500 hover:text-slate-700"
                                                    title="Download Image"
                                                >
                                                    <i className="fas fa-download"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div className="p-4">
                                            <img
                                                src={`data:image/${(message.image_format || 'png').toLowerCase()};base64,${message.image_data}`}
                                                alt="Generated image"
                                                className="max-w-full h-auto rounded border border-slate-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
                                                style={{ maxHeight: '400px', objectFit: 'contain' }}
                                                onClick={() => {
                                                    // Open full-size image in new window
                                                    const newWindow = window.open();
                                                    newWindow.document.write(`
                                                        <html>
                                                            <head><title>Generated Image</title></head>
                                                            <body style="margin:0; background:#000; display:flex; justify-content:center; align-items:center; min-height:100vh;">
                                                                <img src="data:image/${(message.image_format || 'png').toLowerCase()};base64,${message.image_data}" style="max-width:100%; max-height:100%; object-fit:contain;" />
                                                            </body>
                                                        </html>
                                                    `);
                                                }}
                                            />
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Sources */}
                            {message.sources && message.sources.length > 0 && (
                                <div className="mt-3 flex flex-wrap gap-1">
                                    {message.sources.slice(0, 5).map((source, index) => (
                                        <button
                                            key={index}
                                            className="tool-chip text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded-md"
                                            title={source}
                                        >
                                            <i className="fas fa-quote-left mr-1"></i>
                                            ({index + 1})
                                        </button>
                                    ))}
                                </div>
                            )}
                            
                            {/* Fallback Information */}
                            {message.fallback_used && (
                                <div className="mt-2 px-3 py-2 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div className="flex items-center space-x-2 text-sm">
                                        <i className="fas fa-route text-blue-600"></i>
                                        <span className="font-medium text-blue-800">
                                            Fallback Used: {message.fallback_used.replace('_', ' ')}
                                        </span>
                                    </div>
                                    {message.document_assessment && (
                                        <div className="mt-1 text-xs text-blue-700">
                                            <div>Quality Score: {(message.document_assessment.document_quality_score * 100).toFixed(0)}%</div>
                                            <div>Assessment: {message.document_assessment.reason}</div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Right Inspector Component
        function RightInspector({ activePanel, setActivePanel, citations, toolTrace, uploadedPdfs, selectedPdfChunk, setSelectedPdfChunk }) {
            return (
                <div className="w-80 bg-white border-l border-slate-200 flex flex-col">
                    {/* Panel Tabs */}
                    <div className="border-b border-slate-200">
                        <div className="flex">
                            {[
                                { id: 'citations', label: 'Citations', icon: 'fa-quote-left' },
                                { id: 'trace', label: 'Tool Trace', icon: 'fa-code' },
                                { id: 'docs', label: 'Doc Viewer', icon: 'fa-file-text' }
                            ].map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActivePanel(tab.id)}
                                    className={`flex-1 px-3 py-2 text-sm font-medium border-b-2 ${
                                        activePanel === tab.id
                                            ? 'border-teal-500 text-teal-600'
                                            : 'border-transparent text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    <i className={`fas ${tab.icon} mr-1`}></i>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Panel Content */}
                    <div className="flex-1 overflow-y-auto p-4">
                        {activePanel === 'citations' && (
                            <CitationsPanel 
                                citations={citations} 
                                onPdfChunkClick={(filename, chunkId) => {
                                    // Switch to docs panel
                                    setActivePanel('docs');
                                    setSelectedPdfChunk(chunkId);
                                    
                                    // Find and auto-select the PDF by filename
                                    const matchingPdf = uploadedPdfs.find(pdf => 
                                        pdf.filename === filename
                                    );
                                    
                                    if (matchingPdf) {
                                        // This will be handled by the DocViewerPanel
                                        console.log(`Navigating to PDF: ${filename}, Chunk: ${chunkId}`);
                                    }
                                }}
                            />
                        )}
                        {activePanel === 'trace' && (
                            <ToolTracePanel toolTrace={toolTrace} />
                        )}
                        {activePanel === 'docs' && (
                            <DocViewerPanel 
                                uploadedPdfs={uploadedPdfs}
                                selectedPdfChunk={selectedPdfChunk}
                                setSelectedPdfChunk={setSelectedPdfChunk}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Citations Panel
        function CitationsPanel({ citations, onPdfChunkClick }) {
            if (citations.length === 0) {
                return (
                    <div className="text-center py-8 text-slate-500">
                        <i className="fas fa-quote-left text-2xl mb-2"></i>
                        <p>No citations yet</p>
                        <p className="text-xs mt-1">Sources will appear here</p>
                    </div>
                );
            }

            return (
                <div className="space-y-3">
                    {citations.map((citation, index) => {
                        // Parse different citation formats
                        let sourceName = citation;
                        let score = null;
                        let type = 'source';
                        let icon = 'fa-file-text';
                        
                        // Handle routing info (first citation)
                        if (citation.includes('🎯 Routed to:')) {
                            const match = citation.match(/🎯 Routed to: (\w+) \((\d+\.?\d*)% confidence\)/);
                            if (match) {
                                sourceName = `Routed to ${match[1]}`;
                                score = `${match[2]}% confidence`;
                                type = 'routing';
                                icon = 'fa-route';
                            }
                        }
                        // Handle score-based citations
                        else if (citation.includes(' - Score:')) {
                            const parts = citation.split(' - Score:');
                            sourceName = parts[0].trim();
                            score = `Score: ${parts[1].trim()}`;
                            type = 'document';
                            icon = 'fa-file-text';
                        }
                        // Handle PDF citations with chunk IDs
                        else if (citation.includes('.pdf') || citation.includes('pdf_') || citation.includes('chunk_')) {
                            type = 'pdf';
                            icon = 'fa-file-pdf';
                            
                            // Try to extract PDF filename and chunk ID
                            const pdfMatch = citation.match(/([^\/]+\.pdf)/);
                            const chunkMatch = citation.match(/(chunk_\w+|para_\d+|page_\d+)/);
                            
                            if (pdfMatch) {
                                sourceName = pdfMatch[1];
                                if (chunkMatch) {
                                    score = `Chunk: ${chunkMatch[1]}`;
                                    // Store chunk info for click handler
                                    citation.chunkId = chunkMatch[1];
                                    citation.filename = pdfMatch[1];
                                }
                            }
                        }
                        // Handle other citation formats
                        else if (citation.includes('.md')) {
                            type = 'document';
                            icon = 'fa-file-text';
                        }
                        else if (citation.includes('Web Enhanced') || citation.includes('Tavily')) {
                            type = 'web';
                            icon = 'fa-globe';
                        }
                        
                        return (
                            <div key={index} className={`border rounded-md p-3 ${
                                type === 'routing' ? 'border-teal-200 bg-teal-50' :
                                type === 'web' ? 'border-blue-200 bg-blue-50' :
                                type === 'pdf' ? 'border-red-200 bg-red-50' :
                                'border-slate-200'
                            }`}>
                                <div className="flex items-start justify-between mb-2">
                                    <div className="flex items-start space-x-2">
                                        <i className={`fas ${icon} text-sm mt-0.5 ${
                                            type === 'routing' ? 'text-teal-600' :
                                            type === 'web' ? 'text-blue-600' :
                                            type === 'pdf' ? 'text-red-600' :
                                            'text-slate-600'
                                        }`}></i>
                                        <div>
                                            <div className="text-sm font-medium text-slate-800">
                                                {sourceName}
                                            </div>
                                            {score && (
                                                <div className={`text-xs mt-1 ${
                                                    type === 'routing' ? 'text-teal-600' :
                                                    type === 'web' ? 'text-blue-600' :
                                                    type === 'pdf' ? 'text-red-600' :
                                                    'text-slate-500'
                                                }`}>
                                                    {score}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <span className={`text-xs px-2 py-1 rounded ${
                                        type === 'routing' ? 'bg-teal-100 text-teal-700' :
                                        type === 'web' ? 'bg-blue-100 text-blue-700' :
                                        'bg-slate-100 text-slate-600'
                                    }`}>
                                        ({index + 1})
                                    </span>
                                </div>
                                {type === 'document' && (
                                    <button className="text-xs text-slate-600 hover:text-slate-800">
                                        <i className="fas fa-eye mr-1"></i>
                                        View source
                                    </button>
                                )}
                                {type === 'pdf' && citation.chunkId && (
                                    <button 
                                        onClick={() => {
                                            // Switch to docs panel
                                            onPdfChunkClick(citation.filename, citation.chunkId);
                                        }}
                                        className="text-xs text-red-600 hover:text-red-800 transition-colors"
                                    >
                                        <i className="fas fa-external-link-alt mr-1"></i>
                                        View in PDF
                                    </button>
                                )}
                                {type === 'web' && (
                                    <div className="text-xs text-blue-600">
                                        <i className="fas fa-external-link-alt mr-1"></i>
                                        External source
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );
        }

        // Tool Trace Panel
        function ToolTracePanel({ toolTrace }) {
            if (toolTrace.length === 0) {
                return (
                    <div className="text-center py-8 text-slate-500">
                        <i className="fas fa-code text-2xl mb-2"></i>
                        <p>No trace yet</p>
                        <p className="text-xs mt-1">Tool calls will appear here</p>
                    </div>
                );
            }

            return (
                <div className="space-y-3">
                    {toolTrace.map((trace, index) => (
                        <div key={index} className="border border-slate-200 rounded-md">
                            <div className="p-3 border-b border-slate-100">
                                <div className="flex items-center justify-between">
                                    <span className="font-medium text-sm text-slate-800">
                                        {trace.tool}
                                    </span>
                                    <span className="text-xs text-slate-500">
                                        {trace.timestamp.toLocaleTimeString()}
                                    </span>
                                </div>
                            </div>
                            <div className="p-3">
                                <details className="text-xs">
                                    <summary className="cursor-pointer text-slate-600 mb-2">
                                        View details
                                    </summary>
                                    <pre className="bg-slate-50 p-2 rounded text-slate-700 overflow-x-auto">
                                        {JSON.stringify(trace.result, null, 2).slice(0, 500)}...
                                    </pre>
                                </details>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // Doc Viewer Panel  
        function DocViewerPanel({ uploadedPdfs, selectedPdfChunk, setSelectedPdfChunk }) {
            const [selectedPdf, setSelectedPdf] = useState(null);
            const [currentPage, setCurrentPage] = useState(0);
            const [pageData, setPageData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [imgLoaded, setImgLoaded] = useState(null);
            const imgRef = useRef(null);
            
            useEffect(() => {
                if (selectedPdf && currentPage !== null) {
                    loadPageData();
                }
            }, [selectedPdf, currentPage]);
            
            // Auto-select PDF when chunk is selected from citations
            useEffect(() => {
                if (selectedPdfChunk && uploadedPdfs.length > 0 && !selectedPdf) {
                    // Find which PDF contains this chunk
                    const findPdfWithChunk = async () => {
                        for (const pdf of uploadedPdfs) {
                            try {
                                const response = await fetch(`/pdf/${pdf.pdf_id}/info`);
                                const pdfInfo = await response.json();
                                
                                // Check if this PDF has the selected chunk
                                const hasChunk = pdfInfo.chunks && pdfInfo.chunks.some(chunk => 
                                    chunk.chunk_id === selectedPdfChunk
                                );
                                
                                if (hasChunk) {
                                    setSelectedPdf(pdf);
                                    
                                    // Find the page containing this chunk
                                    const matchingChunk = pdfInfo.chunks.find(chunk => 
                                        chunk.chunk_id === selectedPdfChunk
                                    );
                                    
                                    if (matchingChunk) {
                                        setCurrentPage(matchingChunk.page_number || 0);
                                    }
                                    break;
                                }
                            } catch (error) {
                                console.error(`Error checking PDF ${pdf.filename}:`, error);
                            }
                        }
                    };
                    
                    findPdfWithChunk();
                }
            }, [selectedPdfChunk, uploadedPdfs]);
            
            const loadPageData = async () => {
                if (!selectedPdf) return;
                
                setLoading(true);
                try {
                    const response = await fetch(`/pdf/${selectedPdf.pdf_id}/page/${currentPage}`);
                    const data = await response.json();
                    setPageData(data);
                } catch (error) {
                    console.error('Error loading page data:', error);
                } finally {
                    setLoading(false);
                }
            };

            if (uploadedPdfs.length === 0) {
                return (
                    <div className="text-center py-8 text-slate-500">
                        <i className="fas fa-file-pdf text-2xl mb-2"></i>
                        <p>No PDFs uploaded</p>
                        <p className="text-xs mt-1">Upload a PDF to view it here</p>
                    </div>
                );
            }

            if (!selectedPdf) {
                return (
                    <div>
                        <h3 className="font-medium text-slate-800 mb-3">Uploaded PDFs</h3>
                        <div className="space-y-2">
                            {uploadedPdfs.map((pdf, index) => (
                                <button
                                    key={index}
                                    onClick={() => {
                                        setSelectedPdf(pdf);
                                        setCurrentPage(0);
                                    }}
                                    className="w-full p-3 text-left bg-slate-50 hover:bg-slate-100 rounded border border-slate-200"
                                >
                                    <div className="flex items-center space-x-2">
                                        <i className="fas fa-file-pdf text-red-600"></i>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium text-sm text-slate-800 truncate">
                                                {pdf.filename}
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                {pdf.total_pages} pages • {pdf.chunks_extracted} chunks
                                            </div>
                                        </div>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    {/* PDF Header */}
                    <div className="border-b border-slate-200 pb-3 mb-3">
                        <div className="flex items-center justify-between">
                            <button 
                                onClick={() => setSelectedPdf(null)}
                                className="text-slate-500 hover:text-slate-700"
                            >
                                <i className="fas fa-arrow-left"></i>
                            </button>
                            <div className="text-sm font-medium text-slate-800 truncate">
                                {selectedPdf.filename}
                            </div>
                            <div className="text-xs text-slate-500">
                                {currentPage + 1}/{selectedPdf.total_pages}
                            </div>
                        </div>
                    </div>

                    {/* Page Navigation */}
                    <div className="flex items-center justify-center space-x-2 mb-3">
                        <button
                            onClick={() => setCurrentPage(Math.max(0, currentPage - 1))}
                            disabled={currentPage === 0}
                            className="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 disabled:opacity-50 rounded"
                        >
                            <i className="fas fa-chevron-left"></i>
                        </button>
                        <span className="text-xs text-slate-600">
                            Page {currentPage + 1}
                        </span>
                        <button
                            onClick={() => setCurrentPage(Math.min(selectedPdf.total_pages - 1, currentPage + 1))}
                            disabled={currentPage >= selectedPdf.total_pages - 1}
                            className="px-2 py-1 text-xs bg-slate-100 hover:bg-slate-200 disabled:opacity-50 rounded"
                        >
                            <i className="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    {/* PDF Page Viewer */}
                    <div className="relative">
                        {loading ? (
                            <div className="flex items-center justify-center py-8">
                                <div className="animate-spin h-6 w-6 border-2 border-teal-500 border-t-transparent rounded-full"></div>
                            </div>
                        ) : pageData ? (
                            <div className="relative border border-slate-200 rounded overflow-hidden">
                                <img
                                    ref={imgRef}
                                    src={`data:image/png;base64,${pageData.image_base64}`}
                                    alt={`Page ${currentPage + 1}`}
                                    className="w-full h-auto"
                                    onLoad={() => {
                                        // Force re-render of bounding boxes when image loads
                                        setImgLoaded(Date.now());
                                    }}
                                />
                                
                                {/* Bounding Box Overlays */}
                                {imgLoaded && pageData.chunks.map((chunk, index) => {
                                    // Calculate scale factor based on actual image display size
                                    const imgElement = imgRef.current;
                                    if (!imgElement) return null;
                                    
                                    // Get the natural (original) dimensions of the rendered image
                                    const naturalWidth = imgElement.naturalWidth;
                                    const naturalHeight = imgElement.naturalHeight;
                                    
                                    // Get the displayed dimensions
                                    const displayWidth = imgElement.offsetWidth;
                                    const displayHeight = imgElement.offsetHeight;
                                    
                                    // Our coordinates are based on the natural image size
                                    // We need to scale them to the displayed size
                                    const scaleX = displayWidth / naturalWidth;
                                    const scaleY = displayHeight / naturalHeight;
                                    
                                    return (
                                        <div
                                            key={chunk.chunk_id}
                                            className={`absolute border-2 cursor-pointer transition-all ${
                                                selectedPdfChunk === chunk.chunk_id 
                                                    ? 'border-teal-500 bg-teal-500 bg-opacity-20' 
                                                    : 'border-blue-500 bg-blue-500 bg-opacity-10 hover:bg-opacity-20'
                                            }`}
                                            style={{
                                                left: `${chunk.bbox.x * scaleX}px`,
                                                top: `${chunk.bbox.y * scaleY}px`, 
                                                width: `${chunk.bbox.width * scaleX}px`,
                                                height: `${chunk.bbox.height * scaleY}px`
                                            }}
                                            onClick={() => setSelectedPdfChunk(
                                                selectedPdfChunk === chunk.chunk_id ? null : chunk.chunk_id
                                            )}
                                            title={chunk.text}
                                        >
                                            <div className="absolute -top-5 -left-0.5 bg-blue-500 text-white text-xs px-1 rounded">
                                                {index + 1}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : null}
                    </div>

                    {/* Chunk Details */}
                    {selectedPdfChunk && pageData && (
                        <div className="mt-3 p-3 bg-slate-50 rounded border border-slate-200">
                            <h4 className="text-sm font-medium text-slate-800 mb-2">Selected Chunk</h4>
                            {(() => {
                                const chunk = pageData.chunks.find(c => c.chunk_id === selectedPdfChunk);
                                return chunk ? (
                                    <div>
                                        <div className="text-xs text-slate-600 mb-1">
                                            ID: {chunk.chunk_id} • Confidence: {(chunk.confidence * 100).toFixed(1)}%
                                        </div>
                                        <div className="text-sm text-slate-700 max-h-32 overflow-y-auto">
                                            {chunk.text}
                                        </div>
                                    </div>
                                ) : null;
                            })()}
                        </div>
                    )}
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>